name: Release (macOS assets)

on:
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing tag to build & upload macOS assets for (e.g. v1.11.0rc1-mflex2)"
        required: true
        default: "v1.11.0rc1-mflex2"

permissions:
  contents: write

jobs:
  macos-arm64:
    name: macOS (Apple Silicon arm64) build + upload to release
    runs-on: macos-latest
    env:
      HOST: arm64-apple-darwin
    steps:
      - name: Checkout tag
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.tag }}
          fetch-depth: 0

      - name: Install build tools (Homebrew)
        run: |
          brew update
          brew install cmake make ninja pkg-config python@3

          echo "gmake path: $(command -v gmake)"
          gmake --version
          cmake --version
          python3 --version

      - name: Cache depends
        uses: actions/cache@v4
        with:
          path: |
            depends/built
            depends/work
            depends/sources
            depends/${{ env.HOST }}
          key: ${{ runner.os }}-depends-${{ env.HOST }}-${{ hashFiles('depends/packages/*.mk', 'depends/Makefile', 'depends/funcs.mk') }}
          restore-keys: |
            ${{ runner.os }}-depends-${{ env.HOST }}-

      - name: Build depends (WITH Qt)
        run: |
          gmake -C depends HOST=${HOST} -j$(sysctl -n hw.ncpu)

      - name: Configure (CMake via depends toolchain)
        run: |
          TOOLCHAIN="depends/${HOST}/toolchain.cmake"
          test -f "$TOOLCHAIN" || (echo "Missing toolchain: $TOOLCHAIN" && exit 1)

          rm -rf build-probe build
          cmake -S . -B build-probe --toolchain "$TOOLCHAIN" -LH -Wno-dev > cmake_options.txt || true

          EXTRA=""
          grep -q '^ENABLE_GUI:' cmake_options.txt && EXTRA="$EXTRA -DENABLE_GUI=ON"
          grep -q '^BUILD_GUI:'  cmake_options.txt && EXTRA="$EXTRA -DBUILD_GUI=ON"
          grep -q '^ENABLE_IPC:' cmake_options.txt && EXTRA="$EXTRA -DENABLE_IPC=OFF"
          grep -q '^WITH_ZMQ:'   cmake_options.txt && EXTRA="$EXTRA -DWITH_ZMQ=ON"

          cmake -S . -B build --toolchain "$TOOLCHAIN" \
            -DCMAKE_BUILD_TYPE=Release \
            $EXTRA

      - name: Build
        run: |
          cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: Package (prefer deploy, fallback to stage zip)
        run: |
          TAG="${{ inputs.tag }}"
          mkdir -p release-assets

          # Try "deploy" target (usually creates a .zip with .app bundle)
          if cmake --build build --target deploy; then
            FILE="$(find build -maxdepth 6 -type f -name '*.zip' -print -quit || true)"
            if [ -z "$FILE" ]; then
              FILE="$(find build -maxdepth 6 -type f -name '*.dmg' -print -quit || true)"
            fi

            if [ -n "$FILE" ]; then
              EXT="${FILE##*.}"
              cp -v "$FILE" "release-assets/multiflex-${TAG}-macos-arm64.${EXT}"
            fi
          fi

          # Fallback: stage install and zip it
          if [ -z "$(ls -A release-assets 2>/dev/null)" ]; then
            rm -rf stage
            cmake --install build --prefix "$PWD/stage" --strip
            (cd stage && /usr/bin/zip -r "../release-assets/multiflex-${TAG}-macos-arm64.zip" .)
          fi

          ls -la release-assets

      - name: Upload macOS assets to existing GitHub Release for tag
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ inputs.tag }}
          files: release-assets/*
